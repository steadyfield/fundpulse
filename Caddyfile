# FundPulse Caddy 配置
# 同时提供静态文件服务和 API 反向代理

:80

# 启用访问日志和错误日志
log {
	output stdout
	format console
	level DEBUG
}

# Gzip 压缩
encode gzip

# API 代理：基金排行榜接口
# 设置 Referer 绕过防盗链
handle /api/fund-ranking* {
	# 重写路径：将 /api/fund-ranking?xxx 重写为 /data/rankhandler.aspx?xxx
	# 使用 uri replace 替换路径前缀，查询参数会自动保留
	uri replace /api/fund-ranking /data/rankhandler.aspx
	
	# 反向代理到目标服务器（只包含 scheme 和 host）
	reverse_proxy https://fund.eastmoney.com {
		header_up Referer "https://fund.eastmoney.com/"
		header_up Host "fund.eastmoney.com"
		# 移除其他可能干扰的 headers
		header_down -X-Frame-Options
		header_down -X-XSS-Protection
	}
}

# API 代理：基金历史净值接口
# 设置 Referer 绕过防盗链
handle /api/fund-nav-history* {
	# 重写路径：将 /api/fund-nav-history?xxx 重写为 /f10/lsjz?xxx
	# 使用 uri replace 替换路径前缀，查询参数会自动保留
	uri replace /api/fund-nav-history /f10/lsjz
	
	# 反向代理到目标服务器（只包含 scheme 和 host）
	reverse_proxy https://api.fund.eastmoney.com {
		header_up Referer "https://fund.eastmoney.com/"
		header_up Host "api.fund.eastmoney.com"
		# 移除 X-Content-Type-Options（允许 JSONP 执行）
		header_down -X-Content-Type-Options
		# 移除其他可能干扰的 headers
		header_down -X-Frame-Options
		header_down -X-XSS-Protection
	}
}

# API 代理：基金实时估值接口
handle /api/fund-realtime/* {
	# 提取基金代码（例如：/api/fund-realtime/005037.js -> /js/005037.js）
	uri replace /api/fund-realtime /js
	
	# 反向代理到目标服务器
	reverse_proxy https://fundgz.1234567.com.cn {
		header_up Referer "https://fund.eastmoney.com/"
		header_up Host "fundgz.1234567.com.cn"
		# 移除可能干扰的 headers
		header_down -X-Content-Type-Options
		header_down -X-Frame-Options
		header_down -X-XSS-Protection
	}
}

# API 代理：基金净值趋势数据接口（pingzhongdata）
handle /api/fund-pingzhongdata/* {
	# 提取路径（例如：/api/fund-pingzhongdata/005037.js -> /pingzhongdata/005037.js）
	uri replace /api/fund-pingzhongdata /pingzhongdata
	
	# 反向代理到目标服务器
	reverse_proxy https://fund.eastmoney.com {
		header_up Referer "https://fund.eastmoney.com/"
		header_up Host "fund.eastmoney.com"
		# 移除可能干扰的 headers
		header_down -X-Content-Type-Options
		header_down -X-Frame-Options
		header_down -X-XSS-Protection
	}
}

# API 代理：基金详情和持仓接口（FundArchivesDatas）
handle /api/fund-archives* {
	# 重写路径：将 /api/fund-archives?xxx 重写为 /FundArchivesDatas.aspx?xxx
	uri replace /api/fund-archives /FundArchivesDatas.aspx
	
	# 反向代理到目标服务器
	reverse_proxy https://fundf10.eastmoney.com {
		header_up Referer "https://fund.eastmoney.com/"
		header_up Host "fundf10.eastmoney.com"
		# 移除可能干扰的 headers
		header_down -X-Content-Type-Options
		header_down -X-Frame-Options
		header_down -X-XSS-Protection
	}
}

# API 代理：基金搜索接口
handle /api/fund-search* {
	# 重写路径：将 /api/fund-search?xxx 重写为 /FundSearch/api/FundSearchAPI.ashx?xxx
	uri replace /api/fund-search /FundSearch/api/FundSearchAPI.ashx
	
	# 反向代理到目标服务器
	reverse_proxy https://fundsuggest.eastmoney.com {
		header_up Referer "https://fund.eastmoney.com/"
		header_up Host "fundsuggest.eastmoney.com"
		# 移除可能干扰的 headers
		header_down -X-Content-Type-Options
		header_down -X-Frame-Options
		header_down -X-XSS-Protection
	}
}

# 根路径重定向到子路径
handle / {
	redir / /fundpulse/ 301
}

# 处理不带尾部斜杠的 /fundpulse
handle /fundpulse {
	redir /fundpulse /fundpulse/ 301
}

# 静态文件服务（SPA 支持）
handle /fundpulse/* {
	# 移除 /fundpulse 前缀
	uri strip_prefix /fundpulse
	# 设置根目录
	root * /usr/share/caddy/fundpulse
	
	# SPA 路由：对于非静态资源的请求，重写为 index.html
	@spa {
		not path *.js *.css *.png *.jpg *.jpeg *.gif *.ico *.svg *.woff *.woff2 *.ttf *.eot *.webp *.json
	}
	rewrite @spa /index.html
	
	# 提供文件服务
	file_server

	# 静态资源缓存（长期缓存）
	@static {
		path *.js *.css *.png *.jpg *.jpeg *.gif *.ico *.svg *.woff *.woff2 *.ttf *.eot *.webp
	}
	header @static {
		Cache-Control "public, max-age=31536000, immutable"
	}

	# HTML 文件不缓存
	@html {
		path *.html
	}
	header @html {
		Cache-Control "no-cache, no-store, must-revalidate"
		Pragma "no-cache"
	}

	# Service Worker 不缓存
	@sw {
		path *service-worker.js *sw.js *workbox-*.js
	}
	header @sw {
		Cache-Control "no-cache, no-store, must-revalidate"
		Pragma "no-cache"
	}
}

# 处理错误的 Service Worker 路径
handle /_static/* {
	respond 404
}


# 禁止访问隐藏文件
handle /.?* {
	respond 404
}
